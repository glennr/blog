<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>How to test your Elixir Phoenix LiveView apps with k6. &#183; Glenn Roberts</title><meta name=title content="How to test your Elixir Phoenix LiveView apps with k6. &#183; Glenn Roberts"><link rel=canonical href=https://glenn-roberts.com/posts/2022/10/25/how-to-test-your-elixir-phoenix-liveview-apps-with-k6./><link type=text/css rel=stylesheet href=/css/main.bundle.min.72a205376e53d393186276e83e028b778fd835720e8b8a9345952068d6afab5fb349bf0b3d805118e8bf0777476fb30cc667f887b6e4a0cea3a66dcf8208575c.css integrity="sha512-cqIFN25T05MYYnboPgKLd4/YNXIOi4qTRZUgaNavq1+zSb8LPYBRGOi/B3dHb7MMxmf4h7bkoM6jpm3PgghXXA=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="How to test your Elixir Phoenix LiveView apps with k6."><meta property="og:description" content="How to test your Elixir Phoenix LiveView apps with k6."><meta property="og:type" content="article"><meta property="og:url" content="https://glenn-roberts.com/posts/2022/10/25/how-to-test-your-elixir-phoenix-liveview-apps-with-k6./"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-25T23:09:24+10:00"><meta property="article:modified_time" content="2022-10-25T23:09:24+10:00"><meta property="og:site_name" content="Glenn Roberts"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to test your Elixir Phoenix LiveView apps with k6."><meta name=twitter:description content="How to test your Elixir Phoenix LiveView apps with k6."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"How to test your Elixir Phoenix LiveView apps with k6.","headline":"How to test your Elixir Phoenix LiveView apps with k6.","description":"How to test your Elixir Phoenix LiveView apps with k6.","abstract":"Elixir and Phoenix tout high performance with low hardware requirements, and microsecond (μs) response times.","inLanguage":"en","url":"https:\/\/glenn-roberts.com\/posts\/2022\/10\/25\/how-to-test-your-elixir-phoenix-liveview-apps-with-k6.\/","author":{"@type":"Person","name":"Glenn Roberts"},"copyrightYear":"2022","dateCreated":"2022-10-25T23:09:24\u002b10:00","datePublished":"2022-10-25T23:09:24\u002b10:00","dateModified":"2022-10-25T23:09:24\u002b10:00","keywords":["Elixir","Phoenix","LiveView","k6"],"mainEntityOfPage":"true","wordCount":"2146"}]</script><meta name=author content="Glenn Roberts"><link href=https://github.com/glennr rel=me><link href=https://gitlab.com/glennr rel=me><link href=https://keybase.io/glennrob rel=me><link href=https://linkedin.com/in/glennrob rel=me><link href=https://twitter.com/glennrob rel=me><div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-64960058-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-64960058-1")</script></div></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Glenn Roberts</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Posts</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>Categories</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Glenn Roberts' blog</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/2022/10/25/how-to-test-your-elixir-phoenix-liveview-apps-with-k6./>How to test your Elixir Phoenix LiveView apps with k6.</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">How to test your Elixir Phoenix LiveView apps with k6.</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-10-25 23:09:24 +1000 +1000">25 October 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">11 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/glennr/blog/edit/master/content/posts/testing-liveview-with-k6.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M490.3 40.4c21.9 21.87 21.9 57.33.0 79.2l-30 30.1-98-97.98 30.1-30.06C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7 339.7 74.34l98 97.96L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2l-88.8 29.6C150.1 385.6 141.5 383.4 135 376.1 128.6 370.5 126.4 361 129.2 352.4l29.6-88.8C161.6 255.3 166.2 247.8 172.4 241.7v0zM192 63.1c17.7.0 32 15.23 32 32 0 18.6-14.3 32-32 32H96c-17.67.0-32 15.2-32 32V416c0 17.7 14.33 32 32 32H352c17.7.0 32-14.3 32-32V319.1c0-16.8 14.3-32 32-32s32 15.2 32 32V416c0 53-43 96-96 96H96c-53.02.0-96-43-96-96V159.1c0-53 42.98-96 96-96h96z"/></svg></span></a></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#enter-k6>Enter k6</a></li><li><a href=#test-setup>Test setup</a><ul><li><a href=#install-k6>Install k6</a></li><li><a href=#set-up-a-liveview-project>Set up a LiveView project</a></li></ul></li><li><a href=#a-k6-test-script>A k6 test script</a></li><li><a href=#babys-first-melted-cpu>Baby&rsquo;s first melted CPU</a></li><li><a href=#websockets-and-liveview>Websockets and LiveView</a><ul><li><a href=#socket-to-me>Socket to me</a></li></ul></li><li><a href=#where-to-from-here>Where to from here</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><p>Elixir and Phoenix tout high performance with <a href=https://freecontent.manning.com/ride-the-phoenix/>low hardware
requirements</a>, and
<a href=https://medium.com/pinterest-engineering/introducing-new-open-source-tools-for-the-elixir-community-2f7bb0bb7d8c>microsecond (μs) response times</a>. Of course Elixir and Phoenix are only one part of your (production) stack, and thus tell only part of the whole story.</p><p>How well does your Phoenix LiveView app, and infrastructure, perform under stress?</p><p>How do you baseline performance, and how do you measure the impact of changes on that performance?</p><p>Given LiveView relies on websocket communication, how do you test that? How memory hungry are your views?</p><p>I recently had to answer these questions for <a href=www.brmbl.io>Bramble</a> which is an
app built with Phoenix LiveView. I needed something to simulate HTTP and websocket traffic with spikey and sustained workloads.</p><h2 id=enter-k6 class="relative group">Enter k6 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enter-k6 aria-label=Anchor>#</a></span></h2><p>In the past I might have reached for good old <a href=https://jmeter.apache.org>Apache JMeter</a>. The new shiny appears to be <a href=https://k6.io>k6</a>, an open-source load testing tool written by the folks over at Grafana Labs.</p><p>My initial impression was good. You write your tests in JavaScript, using a simple API:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s2>&#34;k6/http&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>sleep</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;k6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;https://test.k6.io&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>k6 ships as a Go binary, optimized for minimal resource consumption. To run a load test, your invoke <code>k6</code> from the command line:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k6 run --vus <span class=m>10</span> --duration 30s script.js
</span></span></code></pre></div><p>This simulates 10 Virtual Users (VUs) over a sustained period of 30 seconds.</p><p>You&rsquo;ll notice <code>k6</code> is <em>fast</em>. It doesn&rsquo;t run those tests in a browser or in a NodeJS runtime, but using its own interpreter. This efficiency is important in a load testing tool, as it means you don&rsquo;t need to rent half of AWS to saturate your application endpoints.</p><p>One added benefit, in the context of testing LiveView, is you don&rsquo;t have to install any extra plugins as <a href=https://k6.io/docs/using-k6/protocols/websockets/>websockets are already supported in k6</a>.</p><h2 id=test-setup class="relative group">Test setup <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#test-setup aria-label=Anchor>#</a></span></h2><p>Here&rsquo;s a worked example of how to get k6 up and running, and how to test a LiveView app.</p><p>The test setup will be simple - we&rsquo;ll run both a LiveView app, and k6, locally. We&rsquo;ll write a k6 test script to exercise Chris McCord&rsquo;s <a href=https://fly.io/blog/livebeats/>LiveBeats project</a>, described as a &ldquo;Social Music App With Phoenix LiveView&rdquo;.</p><p>For a production setup, you&rsquo;ll likely run the tests against a staging or pre-production system instead. Also observe that k6 running locally on a single machine will probably not be good enough for production-like tests. For this use-case, k6 also supports a <a href=https://k6.io/blog/running-distributed-tests-on-k8s/>distributed load test</a> (Kubernetes) or their commercial <a href=https://k6.io/docs/cloud/>k6 Cloud</a>.</p><h3 id=install-k6 class="relative group">Install k6 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#install-k6 aria-label=Anchor>#</a></span></h3><p>First, install k6 per [their instructions](<a href=https://k6.io/docs/getting-started/installation/>https://k6.io/docs/getting-started/installation/</a>. ASDF users can try <a href=https://github.com/grimoh/asdf-k6>https://github.com/grimoh/asdf-k6</a></p><h3 id=set-up-a-liveview-project class="relative group">Set up a LiveView project <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#set-up-a-liveview-project aria-label=Anchor>#</a></span></h3><p>Set up your LiveBeats project per the <a href=https://github.com/fly-apps/live_beats>README</a></p><p>(The setup is a little funky as you need to create a GitHub OAuth app for your
project, but it only takes 2 minutes).</p><p>Open up <a href=http:/localhost:4000>LiveBeats on localhost</a>, and sign in.</p><p>(Optionally create some sample data by uploading a few mp3 files you have lying
around on your hard drive. You still have some right? Right?)</p><p>LiveBeats has two main URLs we&rsquo;re interested in for this load test:</p><ol><li>The &lsquo;My Profile&rsquo; for example <code>/YOUR_GITHUB_USERNAME</code>.</li><li>The Settings page: <code>/profile/settings</code></li></ol><h2 id=a-k6-test-script class="relative group">A k6 test script <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#a-k6-test-script aria-label=Anchor>#</a></span></h2><p>Let&rsquo;s start our k6 test script, and make it hit just the Settings page first.</p><div class=highlight filename=test/k6/load-test.js><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s2>&#34;k6/http&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>sleep</span><span class=p>,</span> <span class=nx>check</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;k6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>__ENV</span><span class=p>.</span><span class=nx>LIVEBEATS_COOKIE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;http://localhost:4000/profile/settings&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// dont follow authentication failure redirects
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>redirects</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cookies</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>_live_beats_key_v1</span><span class=o>:</span> <span class=nx>cookie</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;status 200&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;contains header&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;Profile Settings&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><a href=https://github.com/glennr/live_beats/commit/d17cdff42b0bbe856dc818a04db191dc2bdc0cc9>Source code on GitHub</a></p><p>For simplicity, this script skips GitHub OAuth sign in.
Instead it expects a valid cookie exposed as an environment variable.</p><p>To do this grab the <code>_live_beats_key_v1</code> cookie from your browser, and export it
in the same session you&rsquo;ll run k6.</p><pre tabindex=0><code>% export LIVEBEATS_COOKIE=YOUR_COOKIE
</code></pre><p>To run this script, use the k6 binary you installed:</p><pre tabindex=0><code>
% k6 run test/k6/load-test.js

          /\      |‾‾| /‾‾/   /‾‾/
     /\  /  \     |  |/  /   /  /
    /  \/    \    |     (   /   ‾‾\
   /          \   |  |\  \ |  (‾)  |
  / __________ \  |__| \__\ \_____/ .io

  execution: local
     script: test/k6/load-test.js
     output: -

  scenarios: (100.00%) 1 scenario, 1 max VUs, 10m30s max duration (incl. graceful stop):
           * default: 1 iterations for each of 1 VUs (maxDuration: 10m0s, gracefulStop: 30s)


running (00m01.1s), 0/1 VUs, 1 complete and 0 interrupted iterations
default ✓ [======================================] 1 VUs  00m01.1s/10m0s  1/1 iters, 1 per VU

     ✓ status 200
     ✓ contains header

     checks…………………….: 100.00% ✓ 2        ✗ 0
     data_received………………: 39 kB   37 kB/s
     data_sent………………….: 317 B   297 B/s
     http_req_blocked……………: avg=301.69µs min=301.69µs med=301.69µs max=301.69µs p(90)=301.69µs p(95)=301.69µs
     http_req_connecting…………: avg=133.67µs min=133.67µs med=133.67µs max=133.67µs p(90)=133.67µs p(95)=133.67µs
     http_req_duration…………..: avg=63.55ms  min=63.55ms  med=63.55ms  max=63.55ms  p(90)=63.55ms  p(95)=63.55ms
       { expected_response:true }…: avg=63.55ms  min=63.55ms  med=63.55ms  max=63.55ms  p(90)=63.55ms  p(95)=63.55ms
     http_req_failed…………….: 0.00%   ✓ 0        ✗ 1
     http_req_receiving………….: avg=208.26µs min=208.26µs med=208.26µs max=208.26µs p(90)=208.26µs p(95)=208.26µs
     http_req_sending……………: avg=64.63µs  min=64.63µs  med=64.63µs  max=64.63µs  p(90)=64.63µs  p(95)=64.63µs
     http_req_tls_handshaking…….: avg=0s       min=0s       med=0s       max=0s       p(90)=0s       p(95)=0s
     http_req_waiting……………: avg=63.28ms  min=63.28ms  med=63.28ms  max=63.28ms  p(90)=63.28ms  p(95)=63.28ms
     http_reqs………………….: 1       0.938097/s
     iteration_duration………….: avg=1.06s    min=1.06s    med=1.06s    max=1.06s    p(90)=1.06s    p(95)=1.06s
     iterations…………………: 1       0.938097/s
     vus……………………….: 1       min=1      max=1
     vus_max……………………: 1       min=1      max=1
</code></pre><p>Boom, you can see both checks worked, and various performance statistics for the
run. Our p90 HTTP request duration is 63.55ms.</p><h2 id=babys-first-melted-cpu class="relative group">Baby&rsquo;s first melted CPU <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#babys-first-melted-cpu aria-label=Anchor>#</a></span></h2><p>Now let&rsquo;s add the My Profile page endpoint to the script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s2>&#34;k6/http&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>sleep</span><span class=p>,</span> <span class=nx>check</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;k6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>__ENV</span><span class=p>.</span><span class=nx>LIVEBEATS_COOKIE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>redirects</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cookies</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>_live_beats_key_v1</span><span class=o>:</span> <span class=nx>cookie</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;http://localhost:4000/profile/settings&#34;</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;status 200&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;contains header&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;Profile Settings&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>res</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;http://localhost:4000/glennr&#34;</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;songs status 200&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;contains table&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;Artist&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><a href=https://github.com/glennr/live_beats/commit/7f004cb4de62c028eb55a0df73f2cd48ed846e3d>Full diff</a></p><p>Note this is test doesn&rsquo;t describe a realistic user journey. A sleep time of only 1 second between requests is quite short.</p><p>Next, run this updated k6 script with a twist: dial up the VUs + test duration. This increases both the overall the script iterations, and the load on the app.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>% k6 run test/k6/load-test.js --vus <span class=m>100</span> --duration<span class=o>=</span>10s
</span></span><span class=line><span class=cl>…
</span></span><span class=line><span class=cl>running <span class=o>(</span>12.0s<span class=o>)</span>, 000/100 VUs, <span class=m>500</span> <span class=nb>complete</span> and <span class=m>0</span> interrupted iterations
</span></span><span class=line><span class=cl>default ✓ <span class=o>[======================================]</span> <span class=m>100</span> VUs  10s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     ✓ status <span class=m>200</span>
</span></span><span class=line><span class=cl>     ✓ contains header
</span></span><span class=line><span class=cl>     ✓ songs status <span class=m>200</span>
</span></span><span class=line><span class=cl>     ✓ contains table
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     checks…………………….: 100.00% ✓ <span class=m>2000</span>      ✗ <span class=m>0</span>
</span></span><span class=line><span class=cl>     data_received………………: <span class=m>62</span> MB   5.2 MB/s
</span></span><span class=line><span class=cl>     data_sent………………….: <span class=m>312</span> kB  <span class=m>26</span> kB/s
</span></span><span class=line><span class=cl>     http_req_blocked……………: <span class=nv>avg</span><span class=o>=</span>92.64µs  <span class=nv>min</span><span class=o>=</span>1.56µs  <span class=nv>med</span><span class=o>=</span>4.05µs   <span class=nv>max</span><span class=o>=</span>3.53ms   p<span class=o>(</span>90<span class=o>)=</span>31.17µs  p<span class=o>(</span>95<span class=o>)=</span>346.09µs
</span></span><span class=line><span class=cl>     http_req_connecting…………: <span class=nv>avg</span><span class=o>=</span>34.23µs  <span class=nv>min</span><span class=o>=</span>0s      <span class=nv>med</span><span class=o>=</span>0s       <span class=nv>max</span><span class=o>=</span>2.7ms    p<span class=o>(</span>90<span class=o>)=</span>5.74µs   p<span class=o>(</span>95<span class=o>)=</span>157.69µs
</span></span><span class=line><span class=cl>     http_req_duration…………..: <span class=nv>avg</span><span class=o>=</span>166.02ms <span class=nv>min</span><span class=o>=</span>55.06ms <span class=nv>med</span><span class=o>=</span>158.57ms <span class=nv>max</span><span class=o>=</span>435.99ms p<span class=o>(</span>90<span class=o>)=</span>274.61ms p<span class=o>(</span>95<span class=o>)=</span>323.83ms
</span></span><span class=line><span class=cl>       <span class=o>{</span> expected_response:true <span class=o>}</span>…: <span class=nv>avg</span><span class=o>=</span>166.02ms <span class=nv>min</span><span class=o>=</span>55.06ms <span class=nv>med</span><span class=o>=</span>158.57ms <span class=nv>max</span><span class=o>=</span>435.99ms p<span class=o>(</span>90<span class=o>)=</span>274.61ms p<span class=o>(</span>95<span class=o>)=</span>323.83ms
</span></span><span class=line><span class=cl>     http_req_failed…………….: 0.00%   ✓ <span class=m>0</span>         ✗ <span class=m>1000</span>
</span></span><span class=line><span class=cl>     http_req_receiving………….: <span class=nv>avg</span><span class=o>=</span>155.92µs <span class=nv>min</span><span class=o>=</span>37.41µs <span class=nv>med</span><span class=o>=</span>108.94µs <span class=nv>max</span><span class=o>=</span>2.39ms   p<span class=o>(</span>90<span class=o>)=</span>240.32µs p<span class=o>(</span>95<span class=o>)=</span>327.97µs
</span></span><span class=line><span class=cl>     http_req_sending……………: <span class=nv>avg</span><span class=o>=</span>32.7µs   <span class=nv>min</span><span class=o>=</span>6.24µs  <span class=nv>med</span><span class=o>=</span>17.27µs  <span class=nv>max</span><span class=o>=</span>2.71ms   p<span class=o>(</span>90<span class=o>)=</span>36.1µs   p<span class=o>(</span>95<span class=o>)=</span>100.31µs
</span></span><span class=line><span class=cl>     http_req_tls_handshaking…….: <span class=nv>avg</span><span class=o>=</span>0s       <span class=nv>min</span><span class=o>=</span>0s      <span class=nv>med</span><span class=o>=</span>0s       <span class=nv>max</span><span class=o>=</span>0s       p<span class=o>(</span>90<span class=o>)=</span>0s       p<span class=o>(</span>95<span class=o>)=</span>0s
</span></span><span class=line><span class=cl>     http_req_waiting……………: <span class=nv>avg</span><span class=o>=</span>165.84ms <span class=nv>min</span><span class=o>=</span>54.96ms <span class=nv>med</span><span class=o>=</span>158.41ms <span class=nv>max</span><span class=o>=</span>435.45ms p<span class=o>(</span>90<span class=o>)=</span>274.34ms p<span class=o>(</span>95<span class=o>)=</span>323.64ms
</span></span><span class=line><span class=cl>     http_reqs………………….: <span class=m>1000</span>    83.414907/s
</span></span><span class=line><span class=cl>     iteration_duration………….: <span class=nv>avg</span><span class=o>=</span>2.33s    <span class=nv>min</span><span class=o>=</span>2.14s   <span class=nv>med</span><span class=o>=</span>2.31s    <span class=nv>max</span><span class=o>=</span>2.58s    p<span class=o>(</span>90<span class=o>)=</span>2.46s    p<span class=o>(</span>95<span class=o>)=</span>2.53s
</span></span><span class=line><span class=cl>     iterations…………………: <span class=m>500</span>     41.707454/s
</span></span><span class=line><span class=cl>     vus……………………….: <span class=m>1</span>       <span class=nv>min</span><span class=o>=</span><span class=m>1</span>       <span class=nv>max</span><span class=o>=</span><span class=m>100</span>
</span></span><span class=line><span class=cl>     vus_max……………………: <span class=m>100</span>     <span class=nv>min</span><span class=o>=</span><span class=m>100</span>     <span class=nv>max</span><span class=o>=</span><span class=m>100</span>
</span></span></code></pre></div><p>With the increased Our p90 HTTP request duration has increased to 274ms, and we processed 83 HTTP requests per second.</p><p>Try increasing your VU count and observe what happens. I hit my <a href=/posts/2022/10/26/k6-soak-tests-too-many-open-files/>open file descriptor limit</a> at about 1000 VUs. This crashed the <code>phx.server</code> process, and causing all k6 checks to fail. (The BEAM was still running, of course…)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>% k6 run test/k6/load-test.js --vus <span class=m>1000</span> --duration<span class=o>=</span>10s
</span></span></code></pre></div><h2 id=websockets-and-liveview class="relative group">Websockets and LiveView <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#websockets-and-liveview aria-label=Anchor>#</a></span></h2><p>A common LiveView optimization for heavy pages is to defer certain costly operations until the view <a href=https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#module-life-cycle>upgrades to a stateful connection</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>mount</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>_session</span><span class=p>,</span> <span class=n>socket</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>%{</span><span class=ss>current_user</span><span class=p>:</span> <span class=n>current_user</span><span class=p>}</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>assigns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>connected?</span><span class=p>(</span><span class=n>socket</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=k>do</span> <span class=n>costly</span> <span class=n>things</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=err>…</span>
</span></span></code></pre></div><p>As such, any load test that hits these LiveView endpoints purely over HTTP is a <em>lie</em>. To exercise these code paths in a load test, you have to simulate this life cycle by connecting from the client (k6) back to the server over websockets.</p><p>As mentioned, k6 supports <a href=https://k6.io/docs/using-k6/protocols/websockets/>websockets</a> out of the box. (Note: At time of writing the <a href=https://github.com/grafana/xk6-websockets>xk6-websockets extension</a> may replace this API.) Lets add some extra checks to the k6 script to exercise LiveView websockets</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s2>&#34;k6/http&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>sleep</span><span class=p>,</span> <span class=nx>check</span><span class=p>,</span> <span class=nx>fail</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;k6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ws</span> <span class=nx>from</span> <span class=s2>&#34;k6/ws&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>__ENV</span><span class=p>.</span><span class=nx>LIVEBEATS_COOKIE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>host</span> <span class=o>=</span> <span class=s2>&#34;localhost:4000&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>origin</span> <span class=o>=</span> <span class=sb>`http://</span><span class=si>${</span><span class=nx>host</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>wsProtocol</span> <span class=o>=</span> <span class=s2>&#34;ws&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>redirects</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cookies</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>_live_beats_key_v1</span><span class=o>:</span> <span class=nx>cookie</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>url</span> <span class=o>=</span> <span class=sb>`http://</span><span class=si>${</span><span class=nx>host</span><span class=si>}</span><span class=sb>/profile/settings`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;status 200&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;contains header&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;Profile Settings&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>checkLiveViewUpgrade</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>origin</span><span class=p>,</span> <span class=nx>wsProtocol</span><span class=p>,</span> <span class=nx>cookie</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=o>=</span> <span class=sb>`http://</span><span class=si>${</span><span class=nx>host</span><span class=si>}</span><span class=sb>/glennr`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;songs status 200&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;contains table&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;Artist&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>checkLiveViewUpgrade</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>origin</span><span class=p>,</span> <span class=nx>wsProtocol</span><span class=p>,</span> <span class=nx>cookie</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Where <code>checkLiveViewUpgrade</code> looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Connects the websocket to ensure the LV is upgraded.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// - parse the response HTML to find the LiveView websocket connection information (csrf token, topic etc)
</span></span></span><span class=line><span class=cl><span class=c1>// - build a `phx_join` message payload
</span></span></span><span class=line><span class=cl><span class=c1>// - issue a ws.connect()
</span></span></span><span class=line><span class=cl><span class=c1>//  - including several callback handlers
</span></span></span><span class=line><span class=cl><span class=c1>// - when a socket message was received, we assume the view was upgraded, and the websocket is closed.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>checkLiveViewUpgrade</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>testHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>wsProto</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>cookie</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>response</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>opts</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>debug</span> <span class=o>=</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>debug</span> <span class=o>||</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// The response html contains the LV websocket connection details
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>grabLVProps</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>wsCsrfToken</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>wsCsrfToken</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>phxSession</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>phxSession</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>phxStatic</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>phxStatic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>topic</span> <span class=o>=</span> <span class=sb>`lv:</span><span class=si>${</span><span class=nx>props</span><span class=p>.</span><span class=nx>phxId</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>ws_url</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>wsProto</span><span class=si>}</span><span class=sb>://</span><span class=si>${</span><span class=nx>host</span><span class=si>}</span><span class=sb>/live/websocket?vsn=2.0.0&amp;_csrf_token=</span><span class=si>${</span><span class=nx>wsCsrfToken</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>debug</span><span class=p>)</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`connecting </span><span class=si>${</span><span class=nx>ws_url</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// LV handshake message
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>joinMsg</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>encodeMsg</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>topic</span><span class=p>,</span> <span class=s2>&#34;phx_join&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>params</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>_csrf_token</span><span class=o>:</span> <span class=nx>wsCsrfToken</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>_mounts</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>session</span><span class=o>:</span> <span class=nx>phxSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kr>static</span><span class=o>:</span> <span class=nx>phxStatic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>ws_url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Cookie</span><span class=o>:</span> <span class=sb>`_live_beats_key_v1=</span><span class=si>${</span><span class=nx>cookie</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Origin</span><span class=o>:</span> <span class=nx>testHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=p>(</span><span class=nx>socket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;open&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>socket</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>joinMsg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>debug</span><span class=p>)</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`websocket open: phx_join topic: </span><span class=si>${</span><span class=nx>topic</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>checkMessage</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=sb>`&#34;status&#34;:&#34;ok&#34;`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>socket</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=nx>handleWsError</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;close&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// should we issue a phx_leave here?
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>debug</span><span class=p>)</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;websocket disconnected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=nx>socket</span><span class=p>.</span><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;2 seconds passed, closing the socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>socket</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>fail</span><span class=p>(</span><span class=s2>&#34;websocket closed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=mi>2000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>checkStatus</span><span class=p>(</span><span class=nx>response</span><span class=p>,</span> <span class=mi>101</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Helper functions omitted for brevity, but the <a href=https://github.com/glennr/live_beats/tree/gr/k6-websockets>source code is here</a></p><p>Note: <code>checkLiveViewUpgrade</code> only tests the websocket connects - it doesn&rsquo;t test the contents of the websocket message (like if the <code>phx_reply</code> rendered some expected HTML.)</p><h3 id=socket-to-me class="relative group">Socket to me <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#socket-to-me aria-label=Anchor>#</a></span></h3><p>Lets re-run, using the same test parameters as before (100 VUs over 10 seconds)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>% k6 run test/k6/load-test.js --vus <span class=m>100</span> --duration<span class=o>=</span>10s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          /<span class=se>\ </span>     <span class=p>|</span>‾‾<span class=p>|</span> /‾‾/   /‾‾/
</span></span><span class=line><span class=cl>     /<span class=se>\ </span> /  <span class=se>\ </span>    <span class=p>|</span>  <span class=p>|</span>/  /   /  /
</span></span><span class=line><span class=cl>    /  <span class=se>\/</span>    <span class=se>\ </span>   <span class=p>|</span>     <span class=o>(</span>   /   ‾‾<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   /          <span class=se>\ </span>  <span class=p>|</span>  <span class=p>|</span><span class=se>\ </span> <span class=se>\ </span><span class=p>|</span>  <span class=o>(</span>‾<span class=o>)</span>  <span class=p>|</span>
</span></span><span class=line><span class=cl>  / __________ <span class=se>\ </span> <span class=p>|</span>__<span class=p>|</span> <span class=se>\_</span>_<span class=se>\ \_</span>____/ .io
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  execution: <span class=nb>local</span>
</span></span><span class=line><span class=cl>     script: test/k6/load-test.js
</span></span><span class=line><span class=cl>     output: -
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  scenarios: <span class=o>(</span>100.00%<span class=o>)</span> <span class=m>1</span> scenario, <span class=m>100</span> max VUs, 40s max duration <span class=o>(</span>incl. graceful stop<span class=o>)</span>:
</span></span><span class=line><span class=cl>           * default: <span class=m>100</span> looping VUs <span class=k>for</span> 10s <span class=o>(</span>gracefulStop: 30s<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>running <span class=o>(</span>12.0s<span class=o>)</span>, 000/100 VUs, <span class=m>400</span> <span class=nb>complete</span> and <span class=m>0</span> interrupted iterations
</span></span><span class=line><span class=cl>default ✓ <span class=o>[======================================]</span> <span class=m>100</span> VUs  10s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     ✓ status <span class=m>200</span>
</span></span><span class=line><span class=cl>     ✓ contains header
</span></span><span class=line><span class=cl>     ✓ found WS token
</span></span><span class=line><span class=cl>     ✓ found phx-session
</span></span><span class=line><span class=cl>     ✓ found phx-static
</span></span><span class=line><span class=cl>     ✓ ws msg OK
</span></span><span class=line><span class=cl>     ✓ status OK
</span></span><span class=line><span class=cl>     ✓ songs status <span class=m>200</span>
</span></span><span class=line><span class=cl>     ✓ contains table
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     checks…………………….: 100.00% ✓ <span class=m>5600</span>      ✗ <span class=m>0</span>
</span></span><span class=line><span class=cl>     data_received………………: <span class=m>90</span> MB   7.5 MB/s
</span></span><span class=line><span class=cl>     data_sent………………….: 1.4 MB  <span class=m>113</span> kB/s
</span></span><span class=line><span class=cl>     http_req_blocked……………: <span class=nv>avg</span><span class=o>=</span>53.16µs  <span class=nv>min</span><span class=o>=</span>1.85µs  <span class=nv>med</span><span class=o>=</span>4µs      <span class=nv>max</span><span class=o>=</span>2.7ms    p<span class=o>(</span>90<span class=o>)=</span>144.83µs p<span class=o>(</span>95<span class=o>)=</span>303.66µs
</span></span><span class=line><span class=cl>     http_req_connecting…………: <span class=nv>avg</span><span class=o>=</span>27.56µs  <span class=nv>min</span><span class=o>=</span>0s      <span class=nv>med</span><span class=o>=</span>0s       <span class=nv>max</span><span class=o>=</span>731.28µs p<span class=o>(</span>90<span class=o>)=</span>98.06µs  p<span class=o>(</span>95<span class=o>)=</span>196.82µs
</span></span><span class=line><span class=cl>     http_req_duration…………..: <span class=nv>avg</span><span class=o>=</span>246.2ms  <span class=nv>min</span><span class=o>=</span>48.1ms  <span class=nv>med</span><span class=o>=</span>183.9ms  <span class=nv>max</span><span class=o>=</span>538.6ms  p<span class=o>(</span>90<span class=o>)=</span>510.16ms p<span class=o>(</span>95<span class=o>)=</span>526.17ms
</span></span><span class=line><span class=cl>       <span class=o>{</span> expected_response:true <span class=o>}</span>…: <span class=nv>avg</span><span class=o>=</span>246.2ms  <span class=nv>min</span><span class=o>=</span>48.1ms  <span class=nv>med</span><span class=o>=</span>183.9ms  <span class=nv>max</span><span class=o>=</span>538.6ms  p<span class=o>(</span>90<span class=o>)=</span>510.16ms p<span class=o>(</span>95<span class=o>)=</span>526.17ms
</span></span><span class=line><span class=cl>     http_req_failed…………….: 0.00%   ✓ <span class=m>0</span>         ✗ <span class=m>800</span>
</span></span><span class=line><span class=cl>     http_req_receiving………….: <span class=nv>avg</span><span class=o>=</span>648.09µs <span class=nv>min</span><span class=o>=</span>45.68µs <span class=nv>med</span><span class=o>=</span>111.45µs <span class=nv>max</span><span class=o>=</span>15.77ms  p<span class=o>(</span>90<span class=o>)=</span>731.57µs p<span class=o>(</span>95<span class=o>)=</span>4.37ms
</span></span><span class=line><span class=cl>     http_req_sending……………: <span class=nv>avg</span><span class=o>=</span>50.46µs  <span class=nv>min</span><span class=o>=</span>7.45µs  <span class=nv>med</span><span class=o>=</span>16.99µs  <span class=nv>max</span><span class=o>=</span>890.78µs p<span class=o>(</span>90<span class=o>)=</span>65.12µs  p<span class=o>(</span>95<span class=o>)=</span>268.68µs
</span></span><span class=line><span class=cl>     http_req_tls_handshaking…….: <span class=nv>avg</span><span class=o>=</span>0s       <span class=nv>min</span><span class=o>=</span>0s      <span class=nv>med</span><span class=o>=</span>0s       <span class=nv>max</span><span class=o>=</span>0s       p<span class=o>(</span>90<span class=o>)=</span>0s       p<span class=o>(</span>95<span class=o>)=</span>0s
</span></span><span class=line><span class=cl>     http_req_waiting……………: <span class=nv>avg</span><span class=o>=</span>245.5ms  <span class=nv>min</span><span class=o>=</span>47.96ms <span class=nv>med</span><span class=o>=</span>183.79ms <span class=nv>max</span><span class=o>=</span>525.87ms p<span class=o>(</span>90<span class=o>)=</span>508.92ms p<span class=o>(</span>95<span class=o>)=</span>523.4ms
</span></span><span class=line><span class=cl>     http_reqs………………….: <span class=m>800</span>     66.634307/s
</span></span><span class=line><span class=cl>     iteration_duration………….: <span class=nv>avg</span><span class=o>=</span>2.88s    <span class=nv>min</span><span class=o>=</span>2.31s .config/lvim/spell/en.utf-8.add  <span class=nv>med</span><span class=o>=</span>2.78s    <span class=nv>max</span><span class=o>=</span>3.6s     p<span class=o>(</span>90<span class=o>)=</span>3.5s     p<span class=o>(</span>95<span class=o>)=</span>3.54s
</span></span><span class=line><span class=cl>     iterations…………………: <span class=m>400</span>     33.317153/s
</span></span><span class=line><span class=cl>     vus……………………….: <span class=m>13</span>      <span class=nv>min</span><span class=o>=</span><span class=m>13</span>      <span class=nv>max</span><span class=o>=</span><span class=m>100</span>
</span></span><span class=line><span class=cl>     vus_max……………………: <span class=m>100</span>     <span class=nv>min</span><span class=o>=</span><span class=m>100</span>     <span class=nv>max</span><span class=o>=</span><span class=m>100</span>
</span></span><span class=line><span class=cl>     ws_connecting………………: <span class=nv>avg</span><span class=o>=</span>126.45ms <span class=nv>min</span><span class=o>=</span>39.85ms <span class=nv>med</span><span class=o>=</span>103.19ms <span class=nv>max</span><span class=o>=</span>359.7ms  p<span class=o>(</span>90<span class=o>)=</span>232.6ms  p<span class=o>(</span>95<span class=o>)=</span>305.48ms
</span></span><span class=line><span class=cl>     ws_msgs_received……………: <span class=m>800</span>     66.634307/s
</span></span><span class=line><span class=cl>     ws_msgs_sent……………….: <span class=m>800</span>     66.634307/s
</span></span><span class=line><span class=cl>     ws_session_duration…………: <span class=nv>avg</span><span class=o>=</span>189.21ms <span class=nv>min</span><span class=o>=</span>47.09ms <span class=nv>med</span><span class=o>=</span>145.6ms  <span class=nv>max</span><span class=o>=</span>620.19ms p<span class=o>(</span>90<span class=o>)=</span>378.3ms  p<span class=o>(</span>95<span class=o>)=</span>419.19ms
</span></span><span class=line><span class=cl>     ws_sessions………………..: <span class=m>800</span>     66.634307/s
</span></span></code></pre></div><p>You can also see a set of new websocket-related metrics in the k6 output. As you can see the HTTP request p(90) has almost doubled (510ms vs 274ms). HTTP requests per second dropped to about 66 (from 83). You&rsquo;ll find a lower overall VU threshold because the websockets mean more file descriptors. The main benefit however, is that you are now simulating a more realistic load on your LiveView app.</p><h2 id=where-to-from-here class="relative group">Where to from here <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#where-to-from-here aria-label=Anchor>#</a></span></h2><p>It&rsquo;s possible with <code>k6/ws</code> to simulate navigation within the LiveView (by keeping the websocket open and sending <code>redirect</code> or <code>patch</code> messages). With this approach you should see more exact resource memory consumption (in particular any memory overhead) on your servers.</p><p>If your app uses LiveView, your load scripts may use <a href=%5Bhttps://k6.io/docs/javascript-api/k6-ws/>k6/ws</a> more than <a href=https://k6.io/docs/javascript-api/#k6-http>k6/http</a>. However if <code>k6/http</code> provides you with a &lsquo;good enough&rsquo; load test, start there, as the API is simpler, and your load scripts will be easier to grok. Also check out some <a href=https://k6.io/docs/test-types/introduction/>various test types</a> that k6 has to offer, for example ramping stress tests.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full" width=96 height=96 alt="Glenn Roberts" src=/images/glenn_hu5d42450050772d6647561389297ff3ac_146123_192x192_fill_q75_box_smart1.jpg><div class=place-self-center><div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Glenn Roberts</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Elixir, Full-stack, DevSecOps, Gluer of Things.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/glennr target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://gitlab.com/glennr target=_blank aria-label=Gitlab rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M510.486 284.482l-27.262-83.963c.012.038.016.077.028.115-.013-.044-.021-.088-.033-.132v-.01L429.1 33.871a21.328 21.328.0 00-20.445-14.6A21.038 21.038.0 00388.466 34L337.094 192.154H175L123.533 33.989A21.033 21.033.0 00103.35 19.274h-.113A21.467 21.467.0 0082.86 34L28.888 200.475l-.008.021v0c-.013.042-.019.084-.033.127.012-.038.017-.077.029-.115L1.514 284.482a30.6 30.6.0 0011.117 34.283L248.893 490.427c.035.026.074.041.109.067.1.072.2.146.3.214-.1-.065-.187-.136-.282-.2.015.012.033.02.05.031s.027.015.041.024h.006a11.992 11.992.0 001.137.7c.054.03.1.068.157.1.033.016.064.038.1.054s.053.02.077.032.038.015.056.023c.044.021.092.034.136.057.205.1.421.178.633.264.2.082.389.177.592.248l.025.011c.034.012.064.028.1.04s.083.032.125.046l.05.012c.053.016.11.024.163.039.019.006.042.009.063.015.284.086.579.148.872.213.115.026.225.062.341.083.017.0.032.009.05.012.038.008.073.021.112.027.062.011.122.031.186.04.049.007.1.0.151.012h.033a11.918 11.918.0 001.7.136h.019a11.971 11.971.0 001.7-.136h.033c.05-.008.1.0.153-.012s.124-.029.187-.04c.038-.006.073-.019.11-.027.017.0.032-.009.049-.012.118-.023.231-.059.349-.084.288-.064.578-.126.861-.21.019-.006.039-.008.059-.014.055-.017.113-.024.169-.041.016-.006.035-.007.051-.012.044-.013.086-.032.129-.047s.063-.028.1-.041l.026-.01c.214-.076.417-.175.627-.261s.394-.154.584-.245c.047-.023.1-.036.142-.059.018-.009.04-.015.058-.024s.053-.02.078-.033.068-.04.1-.056c.056-.028.106-.069.161-.1a12.341 12.341.0 001.132-.695c.029-.02.062-.035.092-.056.008-.006.017-.009.024-.015.035-.026.076-.043.11-.068l236.3-171.666A30.6 30.6.0 00510.486 284.482zM408.8 49.48l46.342 142.674H362.46zm-305.6.0 46.428 142.675H56.948zM26.817 299.251a6.526 6.526.0 01-2.361-7.308l20.34-62.42L193.835 420.6zm38.245-82.972h92.411L223.354 419.22zm183.416 273.83c-.047-.038-.092-.079-.138-.118-.009-.008-.018-.018-.028-.026-.091-.075-.18-.152-.268-.231-.172-.15-.341-.3-.5-.462.014.012.029.022.043.035l.055.046a12.191 12.191.0 001.091.929l.012.011c.018.013.033.03.051.045C248.689 490.263 248.58 490.19 248.478 490.109zm7.514-48.482L217.226 322.21 182.839 216.279H329.253zm7.935 48.107c-.091.079-.178.157-.27.233l-.032.028c-.047.038-.091.079-.136.117-.1.08-.209.152-.313.229.018-.013.033-.032.053-.044l.009-.009a11.69 11.69.0 001.086-.926c.014-.013.03-.024.044-.036s.038-.03.054-.047C264.262 489.435 264.1 489.586 263.927 489.734zm90.7-273.455h92.4l-18.91 24.23-139.468 178.7zm130.567 82.967L318.2 420.563 467.284 229.538l20.258 62.393A6.528 6.528.0 01485.189 299.246z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://keybase.io/glennrob target=_blank aria-label=Keybase rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M286.17 419a18 18 0 1018 18 18 18 0 00-18-18zm111.92-147.6c-9.5-14.62-39.37-52.45-87.26-73.71q-9.1-4.06-18.38-7.27A78.43 78.43.0 00244.57 86.29c-12.41-4.1-23.33-6-32.41-5.77-.6-2-1.89-11 9.4-35L198.66 32l-5.48 7.56c-8.69 12.06-16.92 23.55-24.34 34.89a51 51 0 00-8.29-1.25c-41.53-2.45-39-2.33-41.06-2.33-50.61.0-50.75 52.12-50.75 45.88l-2.36 36.68c-1.61 27 19.75 50.21 47.63 51.85l8.93.54a214 214 0 00-46.29 35.54C14 304.66 14 374 14 429.77v33.64l23.32-29.8a148.6 148.6.0 0014.56 37.56c5.78 10.13 14.87 9.45 19.64 7.33 4.21-1.87 10-6.92 3.75-20.11a178.29 178.29.0 01-15.76-53.13l46.82-59.83-24.66 74.11c58.23-42.4 157.38-61.76 236.25-38.59 34.2 10.05 67.45.69 84.74-23.84.72-1 1.2-2.16 1.85-3.22a156.09 156.09.0 012.8 28.43c0 23.3-3.69 52.93-14.88 81.64-2.52 6.46 1.76 14.5 8.6 15.74 7.42 1.57 15.33-3.1 18.37-11.15C429 443 434 414 434 382.32c0-38.58-13-77.46-35.91-110.92zM142.37 128.58l-15.7-.93-1.39 21.79 13.13.78a93 93 0 00.32 19.57l-22.38-1.34a12.28 12.28.0 01-11.76-12.79L107 119c1-12.17 13.87-11.27 13.26-11.32l29.11 1.73a144.35 144.35.0 00-7 19.17zm148.42 172.18a10.51 10.51.0 01-14.35-1.39l-9.68-11.49-34.42 27a8.09 8.09.0 01-11.13-1.08l-15.78-18.64a7.38 7.38.0 011.34-10.34l34.57-27.18-14.14-16.74-17.09 13.45a7.75 7.75.0 01-10.59-1s-3.72-4.42-3.8-4.53a7.38 7.38.0 011.37-10.34L214 225.19s-18.51-22-18.6-22.14a9.56 9.56.0 011.74-13.42 10.38 10.38.0 0114.3 1.37l81.09 96.32a9.58 9.58.0 01-1.74 13.44zM187.44 419a18 18 0 1018 18 18 18 0 00-18-18z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/glennrob target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://twitter.com/glennrob target=_blank aria-label=Twitter rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/posts/2020/09/27/circle-shift-an-array-in-elixir/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Circle Shift an Array in Elixir</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2020-09-27 00:00:00 +0000 UTC">27 September 2020</time></span></span></a></span>
<span><a class="flex text-right group" href=/posts/2022/10/26/k6-soak-tests-too-many-open-files/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">K6 Soak Tests: Too Many Open Files</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-10-26 23:21:33 +1000 +1000">26 October 2022</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><div class=comment><script src=https://utteranc.es/client.js repo=glennr/blog issue-term=pathname label=comment theme=photon-dark crossorigin=anonymous async></script></div></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2022 Glenn Roberts - All rights reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://glenn-roberts.com><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>